/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds
 */

plugins {
  id "com.moowork.node" version "1.3.1"
}

allprojects {
  repositories {
    mavenLocal()
    jcenter()
  }
}


project.ext.SUBPROJS_TO_IGNORE = [
  'packages'
]
configure(subprojects.findAll {!project.ext.SUBPROJS_TO_IGNORE.contains(it.name)}) {
  apply plugin: "com.moowork.node" // version "1.3.1"

  def slash = File.separator
  project.ext.PROJDIR = "${project.buildDir.toString()}${slash}${slash}${slash}".replace("${slash}build${slash}${slash}", '')

  task clean(type: Delete) {}

  task compileJS(type: NpmTask) {}
  compileJS.inputs.file('package.json')
  compileJS.inputs.dir('src')


  task build {}
  build.dependsOn ":packages:${project.name}:compileJS"

  task lint(type: NpmTask) {
    args=['run', 'lint']
  }
  lint.inputs.dir('src')
  lint.outputs.dir('src')
  build.shouldRunAfter ":packages:${project.name}:lint"


  task test(type: NpmTask) {}
  test.inputs.files('package.json')
  test.inputs.dir('src')
  test.inputs.dir('test')
  // test.dependsOn ":packages:${project.name}:npmClean"
  test.dependsOn ":packages:${project.name}:lint"
  test.dependsOn build
  // build.dependsOn npmInstall

  npmInstall.enabled = false
}


def slash = File.separator
def markerName = ".${slash}node_modules${slash}react4xp${slash}npmInstalled.txt"

task npmDoInstall(type: NpmTask) {
  args=['install']

  inputs.files('package.json', 'package-lock.json', 'build.gradle')
  outputs.file('package-lock.json')
  outputs.file file(markerName)

  doLast {
    def marker = new File(markerName)
    new File(marker.getParent()).mkdirs()
    marker.text = """
Marker file, indicating that the npmInstall gradle task has been run in the root project - faster than traversing the entire node_modules tree for changes.
"""
  }
}

task npmPostInstall(type: NpmTask) {
  args=['run', 'npmLink']
}

npmInstall.enabled = false;
npmInstall.dependsOn npmPostInstall
npmPostInstall.dependsOn npmDoInstall


///////////////////////////////////////////////////

apply from: 'versionAndPublish.gradle'
