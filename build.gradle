/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds
 */

plugins {
  id "com.enonic.xp.app" version "2.0.0"
  id "com.moowork.node" version "1.3.1"
}

allprojects {
  repositories {
    mavenLocal()
    jcenter()
  }

  task cleanNpm(type: Delete) {
    delete 'node_modules'
  }

  /*
  node {
    download = true
    version = '9.7.0'
  }
 */

}

app {
  systemVersion = "${xpVersion}"
}

def ignoreSubprojectDirs = [
        'packages'
]
configure(subprojects.findAll {!ignoreSubprojectDirs.contains(it.name)}) {
  project.ext.PROJDIR = "${project.buildDir.toString()}${File.separator}${File.separator}${File.separator}".replace("${File.separator}build${File.separator}${File.separator}", '')

  npmInstall.inputs.files('package.json', 'package-lock.json')
  npmInstall.outputs.file('package-lock.json')
  npmInstall.outputs.file file("${PROJDIR}/node_modules/npmInstalled.txt")
  npmInstall.doLast {
    def initFile = new File("${PROJDIR}/node_modules/npmInstalled.txt")
    initFile.text = """
Marker file, indicating that the npmInstall gradle task has been run in this subproject - faster than traversing the entire node_modules tree for changes.
"""
  }

  task cleanBuilt(type: Delete) {}
  task npmClean(type: Delete) {
    delete 'node_modules'
  }

  task compileJS(type: NpmTask) {}
  task buildAll {}
  buildAll.dependsOn += ":packages:${project.name}:compileJS"
  task lint(type: NpmTask) {
    args=['run', 'lint']
  }
  lint.inputs.file('package.json')
  lint.inputs.dir('src')
  lint.outputs.dir('src')
  lint.dependsOn += ":packages:${project.name}:npmInstall"

  task testAll(type: NpmTask) {}

  compileJS.dependsOn += ":packages:${project.name}:npmInstall"
  testAll.dependsOn += ":packages:${project.name}:lint"
  testAll.shouldRunAfter ":packages:${project.name}:lint"
  testAll.dependsOn += ":packages:${project.name}:buildAll"
  buildAll.shouldRunAfter ":packages:${project.name}:lint"


  task doPublish(type: NpmTask) {
    args=['publish', '--dry-run']
  }
  doPublish.dependsOn += ":packages:${project.name}:testAll"
  task postPublish {}
  postPublish.dependsOn += ":packages:${project.name}:cleanBuilt"
  cleanBuilt.shouldRunAfter ":packages:${project.name}:doPublish"
  postPublish.dependsOn += ":packages:${project.name}:doPublish"
  task publish {}
  publish.dependsOn += ":packages:${project.name}:postPublish"

  task makeLink(type: NpmTask) {
    args=['link']
  }
  makeLink.dependsOn += ":packages:${project.name}:compileJS"
}

dependencies {
  include project(":packages:constants")
  include project(":packages:buildcomponents")
}

npmInstall.inputs.files('package.json', 'package-lock.json')
npmInstall.outputs.file('package-lock.json')
npmInstall.outputs.file file("./node_modules/npmInstalled.txt")
npmInstall.doLast {
  def initFile = new File("./node_modules/npmInstalled.txt")
  initFile.text = """
Marker file, indicating that the npmInstall gradle task has been run in the root project - faster than traversing the entire node_modules tree for changes.
"""
}
